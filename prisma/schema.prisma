// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  userId            String  @id
  userName          String
  email             String  @unique
  passwordHash      String
  roleId            String
  createdAt         DateTime @default(now())
  role              Role     @relation(fields:[roleId], references:[roleId])
  courses           UserCourse[]
}

model Role {
  roleId            String  @id
  name              roleName
  permissions       Permission[]
  user              User[]
}

model Course {
  courseId          String  @id
  title             String
  nrc               Int   @unique
  period            String
  group             Int
  createdAt         DateTime @default(now())
  users             UserCourse[]
  challenges        ChallengeCourse[]
  evaluations       EvaluationCourse[]
}

model UserCourse {
  id                String  @id @default(cuid())
  userId            String
  courseId          String
  score             Int?
  user              User    @relation(fields:[userId], references:[userId])
  course            Course  @relation(fields:[courseId], references:[courseId])
  @@unique([userId, courseId])
}

model ChallengeCourse {
  id                String    @id @default(cuid())
  challengeId       String
  courseId          String
  challenge         Challenge @relation(fields:[challengeId], references:[challengeId])
  course            Course    @relation(fields:[courseId], references:[courseId])
  @@unique([challengeId, courseId])
}

model EvaluationCourse {
  id                String    @id @default(cuid())
  evaluationId      String
  courseId          String
  evaluation        Evaluation @relation(fields:[evaluationId], references:[evaluationId])
  course            Course     @relation(fields:[courseId], references:[courseId])
  @@unique([evaluationId, courseId])
}

model Permission{
  permissionId      String  @id
  roleId            String
  name              String
  description       String
  rol               Role     @relation(fields:[roleId], references:[roleId])
}

model Challenge {
  challengeId       String  @id
  title             String
  difficulty        Difficulty
  tags              String[]
  timeLimit         Int
  memoryLimit       Int
  description       String
  state             challengeState
  submissions       Submission[]
  testCases         TestCase[]
  evaluations       EvaluationChallenge[]
  courses           ChallengeCourse[]
}

model TestCase {
  testCaseId        String  @id
  challengeId       String
  input             String
  output            String
  challenge         Challenge   @relation(fields:[challengeId], references:[challengeId])
}

model Submission {
  submissionId      String  @id
  user              String
  challengeId       String
  language          Language
  status            StatusSubmission
  createdAt         DateTime  @default(now())
  score             Int?
  timeMsTotal       Int?
  cases             CaseResult[]
  challenge         Challenge @relation(fields:[challengeId], references:[challengeId])
}

model Job {
  id                String    @id
  fileKey           String
  inputKey          String
  language          String
  status            JobStatus @default(QUEUED)
  output            String?
  error             String?
  exitCode          Int?
  executionTime     Int?
  memoryUsed        Int?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model CaseResult {
  caseId            String  @id
  status            String
  timeMs            Int
  submissionId      String
  submission        Submission  @relation(fields:[submissionId], references:[submissionId])
}

model Evaluation {
  evaluationId      String  @id
  name              String
  date              String
  duration          Int
  challenges        EvaluationChallenge[] 
  courses           EvaluationCourse[]
}

model EvaluationChallenge {
  id                String    @id @default(cuid())
  evaluationId      String
  challengeId       String
  evaluation        Evaluation @relation(fields: [evaluationId], references: [evaluationId])
  challenge         Challenge  @relation(fields: [challengeId], references: [challengeId])
  @@unique([evaluationId, challengeId])
}

enum Difficulty {
  Easy 
  Medium
  Hard
}

enum challengeState {
  Draft
  Published
  Archived
}

enum Language {
  Python
  CPlusPlus @map("C++")
  Java
  Node      @map("Node.js")
}

enum StatusSubmission {
    QUEUED
    RUNNING 
    ACCEPTED 
    WRONG_ANSWER
    TIME_LIMIT_EXCEEDED
    RUNTIME_ERROR
    COMPILATION_ERROR
}

enum roleName {
  Admin
  Student
}

enum JobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
}